// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// EMPLOYEE - Zaměstnanec
// ============================================
model Employee {
  id             String   @id @default(uuid())
  personalNumber String   @unique // 4 číslice (0001-9999)
  pin            String   // 6 číslic, hashed
  fullName       String
  email          String?
  phone          String?
  roles          Role[]
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  measurements   Measurement[]
  serviceTickets ServiceTicket[] @relation("AssignedTickets")
  auditLogs      AuditLog[]
  statusChanges  OrderStatusHistory[]

  @@map("employees")
}

enum Role {
  admin              // Správce systému - nastavení, uživatelé
  sales              // Obchodník - leady, zákazníci, zakázky, servis
  manager            // Manažer - vidí vše (read-only)
  production_manager // Vedoucí výroby - zákazníci, zakázky, zaměření (read)
  technician         // Technik/Zaměřovač - zaměření, servis, vidí zákazníky/zakázky
}

// ============================================
// CUSTOMER - Zákazník
// ============================================
model Customer {
  id        String         @id @default(uuid())
  fullName  String
  email     String?
  phone     String
  company   String?
  note      String?
  source    CustomerSource @default(manual)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  locations      Location[]
  orders         Order[]
  leads          Lead[]
  serviceTickets ServiceTicket[]
  inquiries      Inquiry[]

  @@map("customers")
}

enum CustomerSource {
  manual
  advisor
  import
  web
}

// ============================================
// LOCATION - Místo realizace
// ============================================
model Location {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  street  String
  city    String
  zip     String
  country String  @default("CZ")
  gpsLat  Float?
  gpsLng  Float?
  note    String?

  createdAt DateTime @default(now())

  // Relations
  orders Order[]

  @@map("locations")
}

// ============================================
// PRODUCT - Typ pergoly
// ============================================
model Product {
  id          String  @id @default(uuid())
  code        String  @unique // KLIMO, HORIZONTAL, KLASIK...
  name        String
  description String?
  isActive    Boolean @default(true)

  // Relations
  orders Order[]

  @@map("products")
}

// ============================================
// ORDER - Zakázka
// ============================================
model Order {
  id          String @id @default(uuid())
  orderNumber String @unique // FUT-2026-0001

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  productId String?
  product   Product? @relation(fields: [productId], references: [id])

  status   OrderStatus @default(lead)
  priority Priority    @default(normal)

  estimatedValue Decimal?
  finalValue     Decimal?

  deadlineAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Relations
  measurement    Measurement?
  serviceTickets ServiceTicket[]
  statusHistory  OrderStatusHistory[]

  @@map("orders")
}

enum OrderStatus {
  lead
  contacted
  measurement_scheduled
  measurement_done
  quote_sent
  quote_approved
  in_production
  production_done
  installation_scheduled
  installed
  completed
  cancelled
}

enum Priority {
  low
  normal
  high
  urgent
}

// ============================================
// ORDER STATUS HISTORY
// ============================================
model OrderStatusHistory {
  id String @id @default(uuid())

  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  fromStatus  OrderStatus?
  toStatus    OrderStatus
  changedById String?
  changedBy   Employee?    @relation(fields: [changedById], references: [id])
  note        String?
  createdAt   DateTime     @default(now())

  @@map("order_status_history")
}

// ============================================
// MEASUREMENT - Zaměření
// ============================================
model Measurement {
  id String @id @default(uuid())

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id])

  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])

  measuredAt DateTime @default(now())

  // Core fields
  pergolaType     String
  width           Int // mm
  depth           Int // mm
  height          Int // mm
  clearanceHeight Int? // mm

  // Flexible details (JSONB)
  details Json

  // Photos
  photos String[]

  // Metadata
  deviceInfo Json?
  gpsLat     Float?
  gpsLng     Float?

  // PDF
  pdfUrl        String?
  pdfGeneratedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("measurements")
}

// ============================================
// SERVICE TICKET
// ============================================
model ServiceTicket {
  id           String @id @default(uuid())
  ticketNumber String @unique // SRV-2026-0001

  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  assignedToId String?
  assignedTo   Employee? @relation("AssignedTickets", fields: [assignedToId], references: [id])

  type     ServiceType
  status   ServiceStatus @default(new_ticket)
  priority Priority      @default(normal)

  description String
  resolution  String?

  scheduledAt DateTime?
  resolvedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("service_tickets")
}

enum ServiceType {
  warranty
  paid
  maintenance
  complaint
}

enum ServiceStatus {
  new_ticket
  assigned
  scheduled
  in_progress
  resolved
  closed
}

// ============================================
// LEAD - Lead z Rádce
// ============================================
model Lead {
  id String @id @default(uuid())

  name  String?
  email String?
  phone String?

  // Výsledek rádce
  answers            Json // { q1: [1,3], q2: [2], ... }
  scores             Json // { KLIMO: 12, HORIZONTAL: 8, ... }
  recommendedProduct String

  customerNote String?

  // Konverze
  customerId  String?
  customer    Customer? @relation(fields: [customerId], references: [id])
  convertedAt DateTime?

  // Metadata
  ipAddress   String?
  userAgent   String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?

  createdAt DateTime @default(now())

  @@map("leads")
}

// ============================================
// AUDIT LOG
// ============================================
model AuditLog {
  id String @id @default(uuid())

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id])

  action     String // CREATE, UPDATE, DELETE, LOGIN, EXPORT...
  entityType String // Order, Customer, Measurement...
  entityId   String?

  oldValue Json?
  newValue Json?

  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// ============================================
// IMPORT LOG
// ============================================
model ImportLog {
  id String @id @default(uuid())

  employeeId String
  fileName   String
  fileType   String // xlsx, csv

  status      ImportStatus
  totalRows   Int
  successRows Int
  errorRows   Int

  errors Json? // [{ row: 5, field: "phone", error: "Invalid format" }]

  createdAt DateTime @default(now())

  @@map("import_logs")
}

enum ImportStatus {
  processing
  completed
  failed
  partial
}

// ============================================
// PUSH SUBSCRIPTION
// ============================================
model PushSubscription {
  id         String @id @default(uuid())
  employeeId String

  endpoint String
  p256dh   String
  auth     String

  createdAt DateTime @default(now())

  @@map("push_subscriptions")
}

// ============================================
// INQUIRY - Poptávka z rádce
// ============================================
model Inquiry {
  id        String        @id @default(uuid())
  
  // Kontaktní údaje
  fullName  String
  email     String
  phone     String?
  note      String?
  
  // Odpovědi z rádce
  purpose   String        // relax, dining, pool, parking
  size      String        // small, medium, large, xl
  roofType  String        // bioclimatic, fixed, retractable, glass
  extras    String[]      // led, heating, blinds, sensors
  budget    String        // economy, standard, premium, luxury
  
  // Doporučený produkt
  recommendedProduct String
  
  // Stav zpracování
  status    InquiryStatus @default(new)
  assignedTo String?      // Employee ID
  
  // Konverze na zákazníka
  customerId  String?
  customer    Customer?   @relation(fields: [customerId], references: [id])
  convertedAt DateTime?
  
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  
  @@map("inquiries")
}

enum InquiryStatus {
  new
  contacted
  converted  // Zpracováno - vytvořen zákazník
  lost
}
